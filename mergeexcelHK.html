<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¯è‚¡æŠ¥è¡¨åˆå¹¶å¤„ç†</title>
    <!-- SheetJS CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #333;
        }
        .file-input-container {
            margin: 10px 0;
            display: flex;
            align-items: center;
        }
        .file-input-container label {
            width: 120px;
            font-weight: bold;
        }
        .file-input-container input {
            margin-right: 10px;
        }
        #merge-button {
            padding: 10px 20px;
            background: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 20px 0;
        }
        #merge-button:hover {
            background: #0056b3;
        }
        #log {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>æ¸¯è‚¡æŠ¥è¡¨åˆå¹¶å¤„ç†</h1>
    <p>è¯·åˆ†åˆ«ä¸Šä¼ åˆ©æ¶¦è¡¨ã€èµ„äº§è´Ÿå€ºè¡¨å’Œç°é‡‘æµé‡è¡¨çš„ Excel æ–‡ä»¶ï¼Œç„¶åç‚¹å‡»â€œåˆå¹¶â€ç”Ÿæˆæ–°æ–‡ä»¶ã€‚</p>
    
    <div class="file-input-container">
        <label for="profit-file">åˆ©æ¶¦è¡¨:</label>
        <input type="file" id="profit-file" accept=".xlsx,.xls" />
        <span id="profit-file-name"></span>
    </div>
    <div class="file-input-container">
        <label for="balance-file">èµ„äº§è´Ÿå€ºè¡¨:</label>
        <input type="file" id="balance-file" accept=".xlsx,.xls" />
        <span id="balance-file-name"></span>
    </div>
    <div class="file-input-container">
        <label for="cashflow-file">ç°é‡‘æµé‡è¡¨:</label>
        <input type="file" id="cashflow-file" accept=".xlsx,.xls" />
        <span id="cashflow-file-name"></span>
    </div>
    <button id="merge-button" onclick="mergeExcels()">åˆå¹¶</button>
    
    <h2>æ—¥å¿—è¾“å‡º</h2>
    <div id="log"></div>

    <script>
        // åµŒå…¥ config æ•°æ®
        const config = {
            "output_file": "åˆå¹¶æŠ¥è¡¨ç»“æœ.xlsx",
            "sheets": [
            {
      "name": "åˆ©æ¶¦è¡¨",
      "row_map": {
        "1": 1,
        "5": 2,
        "6": 3,
        "7": 4,
        "8": 5,
        "9": 6,
        "10": 7,
        "11": 8,
        "12": 9,
        "13": 10,
        "14": 12,
        "15": 13,
        "16": 14,
        "17": 15,
        "18": 16,
        "19": 17,
        "20": 18,
        "21": 21,
        "22": 23,
        "23": 24
      }
    },
    {
      "name": "èµ„äº§è´Ÿå€ºè¡¨",
      "row_map": {
        "4": 26,
        "5": 27,
        "6": 28,
        "7": 30,
        "8": 31,
        "9": 32,
        "10": 33,
        "11": 35,
        "12": 36,
        "13": 37,
        "14": 41,
        "15": 42,
        "16": 44,
        "17": 45,
        "18": 46,
        "19": 47,
        "20": 48,
        "21": 49,
        "22": 50,
        "23": 51,
        "24": 52,
        "25": 53,
        "26": 54,
        "27": 55,
        "28": 56,
        "29": 57,
        "30": 58,
        "31": 59,
        "32": 61,
        "33": 62,
        "34": 64,
        "35": 65,
        "36": 66,
        "37": 67,
        "38": 68,
        "39": 69
      }
    },
    {
      "name": "ç°é‡‘æµé‡è¡¨",
      "row_map": {
        "6": 72,
        "7": 73,
        "8": 74,
        "9": 75,
        "10": 76,
        "11": 77,
        "12": 78,
        "13": 79,
        "14": 82,
        "15": 83,
        "16": 84,
        "17": 85,
        "18": 86,
        "19": 87,
        "20": 90,
        "21": 91,
        "22": 92,
        "23": 95,
        "24": 96,
        "25": 97
      }
    }
            ]
        };

        // æ˜¾ç¤ºé€‰æ‹©çš„æ–‡ä»¶å
        function updateFileName(inputId, displayId) {
            const input = document.getElementById(inputId);
            const display = document.getElementById(displayId);
            input.addEventListener('change', () => {
                display.textContent = input.files[0] ? input.files[0].name : 'æœªé€‰æ‹©æ–‡ä»¶';
            });
        }
        updateFileName('profit-file', 'profit-file-name');
        updateFileName('balance-file', 'balance-file-name');
        updateFileName('cashflow-file', 'cashflow-file-name');

        // æ—¥å¿—è¾“å‡ºå‡½æ•°
        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.innerText += message + '\n';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // æ£€æŸ¥ç›®æ ‡è¡Œé‡å¤
        function checkDuplicateTargets(config) {
            const duplicateInfo = [];
            config.sheets.forEach(sheet => {
                const targetCount = {};
                for (const [sourceRow, targetRow] of Object.entries(sheet.row_map)) {
                    if (!targetCount[targetRow]) targetCount[targetRow] = [];
                    targetCount[targetRow].push(sourceRow);
                }
                for (const [target, sources] of Object.entries(targetCount)) {
                    if (sources.length > 1) {
                        duplicateInfo.push(`âš ï¸ã€${sheet.name}ã€‘ä¸­ç›®æ ‡è¡Œå· ${target} è¢«å¤šä¸ªæºè¡Œæ˜ å°„ï¼š${sources}`);
                    }
                }
            });
            return duplicateInfo;
        }

        // æ¸…ç†ç¬¬ä¸€åˆ—æ–‡æœ¬
        function cleanCellValue(value) {
            if (typeof value === 'string') {
                const originalValue = value;
                // ç§»é™¤å…¨è§’ç©ºæ ¼ (U+3000) å’ŒåŠè§’ç©ºæ ¼ (U+0020)
                value = value.replace(/\u3000/g, '').replace(/ /g, '');
                // ç§»é™¤ä¸å¯è§æ§åˆ¶å­—ç¬¦
                value = value.replace(/[\x00-\x1F\x7F]/g, '');
                if (value !== originalValue) {
                    log(`ğŸ” æ¸…ç†ç¬¬ä¸€åˆ—æ–‡æœ¬ï¼šåŸå§‹='${originalValue}'ï¼Œæ¸…ç†å='${value}'ï¼ŒUnicode=${JSON.stringify([...value].map(c => c.charCodeAt(0)))}`);
                }
                return value || ''; // ç©ºå­—ç¬¦ä¸²è½¬ä¸º ''
            }
            return value == null ? '' : value; // null æˆ– undefined è½¬ä¸º ''
        }

        // è·å–åˆå¹¶å•å…ƒæ ¼å€¼
        function getMergedCellValue(ws, row, col, merges) {
            const cellAddress = XLSX.utils.encode_cell({ r: row - 1, c: col - 1 });
            for (const merge of merges || []) {
                if (cellAddress >= merge.s && cellAddress <= merge.e) {
                    const startCell = XLSX.utils.encode_cell({ r: merge.s.r, c: merge.s.c });
                    log(`ğŸ” æ£€æµ‹åˆ°åˆå¹¶å•å…ƒæ ¼ï¼š${merge.s.r + 1}:${merge.s.c + 1} åˆ° ${merge.e.r + 1}:${merge.e.c + 1}ï¼Œä½¿ç”¨é¦–å•å…ƒæ ¼å€¼`);
                    return ws[startCell] ? cleanCellValue(ws[startCell].v) : '';
                }
            }
            return ws[cellAddress] ? cleanCellValue(ws[cellAddress].v) : '';
        }

        // æå–è¡Œæ•°æ®
        function extractRowsByMap(file, rowMap, sheetName) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const ws = workbook.Sheets[workbook.SheetNames[0]];
                    const range = XLSX.utils.decode_range(ws['!ref'] || 'A1:A1');
                    const maxRow = range.e.r + 1;
                    const maxCol = range.e.c + 1;
                    const merges = ws['!merges'] || [];
                    const extracted = {};



                    const seenTargets = new Set();
                    for (const [sourceRowStr, targetRow] of Object.entries(rowMap)) {
                        log(`ğŸ” å¤„ç†æºè¡Œå·ï¼š${sourceRowStr}ï¼Œç›®æ ‡è¡Œå·ï¼š${targetRow}`);
                        try {
                            const sourceRow = parseInt(sourceRowStr);
                            if (sourceRow > maxRow) {
                                log(`âŒ é”™è¯¯ï¼šæºè¡Œå· ${sourceRow} è¶…å‡º Excel æ–‡ä»¶æœ€å¤§è¡Œæ•° ${maxRow}`);
                                continue;
                            }
                            if (seenTargets.has(targetRow)) {
                                log(`âš ï¸ è­¦å‘Šï¼šç›®æ ‡è¡Œå· ${targetRow} å·²é‡å¤ï¼Œå¿½ç•¥æºè¡Œ ${sourceRow}`);
                                continue;
                            }
                            const values = [];
                            for (let col = 1; col <= maxCol; col++) {
                                values.push(getMergedCellValue(ws, sourceRow, col, merges));
                            }
                            log(`ğŸ” ç¬¬${sourceRow}è¡ŒåŸå§‹æ•°æ®ï¼š${JSON.stringify(values)}`);
                            if (!values.some(v => typeof v === 'string' && v.trim())) {
                                log(`âš ï¸ è­¦å‘Šï¼šç¬¬${sourceRow}è¡Œå†…å®¹ä¸ºç©ºï¼Œè·³è¿‡`);
                                continue;
                            }
                            extracted[targetRow] = values;
                            seenTargets.add(targetRow);
                            log(`âœ… ç¬¬${sourceRow}è¡Œ â†’ åˆå¹¶ç¬¬${targetRow}è¡Œï¼š${JSON.stringify(values)}`);
                        } catch (e) {
                            log(`âŒ æå–é”™è¯¯ï¼š${sheetName} ç¬¬${sourceRow}è¡Œ â†’ ç¬¬${targetRow}è¡Œï¼Œé”™è¯¯ä¿¡æ¯ï¼š${e.message}`);
                        }
                    }
                    resolve(extracted);
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // åˆå¹¶ Excel æ–‡ä»¶
        async function mergeExcels() {
            const files = [
                document.getElementById('profit-file').files[0],
                document.getElementById('balance-file').files[0],
                document.getElementById('cashflow-file').files[0]
            ];
            if (files.some(f => !f)) {
                log(`âŒ é”™è¯¯ï¼šè¯·ä¸Šä¼ æ‰€æœ‰ä¸‰ä¸ª Excel æ–‡ä»¶ï¼ˆåˆ©æ¶¦è¡¨ã€èµ„äº§è´Ÿå€ºè¡¨ã€ç°é‡‘æµé‡è¡¨ï¼‰`);
                return;
            }
            if (files.length !== config.sheets.length) {
                log(`âŒ é”™è¯¯ï¼šåº”ä¸Šä¼  ${config.sheets.length} ä¸ª Excel æ–‡ä»¶ï¼Œå½“å‰ä¸Šä¼ äº† ${files.length} ä¸ª`);
                return;
            }

            log(`ğŸ“‹ config å†…å®¹ï¼š${JSON.stringify(config, null, 2)}`);
            const duplicateInfo = checkDuplicateTargets(config);
            if (duplicateInfo.length > 0) {
                log(`\nğŸš« æ£€æŸ¥åˆ°ç›®æ ‡è¡Œå·é‡å¤ï¼Œä»¥ä¸‹æ˜ å°„å­˜åœ¨å†²çªï¼Œå°†åªä¿ç•™ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ˜ å°„ï¼š`);
                duplicateInfo.forEach(info => log(info));
                log('');
            }

            const finalData = {};
            for (let idx = 0; idx < config.sheets.length; idx++) {
                const sheetInfo = config.sheets[idx];
                log(`\nğŸ“‹ å¤„ç†å·¥ä½œè¡¨ï¼š${sheetInfo.name}`);
                log(`ğŸ“‹ å·¥ä½œè¡¨é…ç½®ï¼š${JSON.stringify(sheetInfo, null, 2)}`);
                const rowMap = sheetInfo.row_map;
                const file = files[idx];
                const extracted = await extractRowsByMap(file, rowMap, sheetInfo.name);
                Object.assign(finalData, extracted);
            }

            // åˆ›å»ºæ–°å·¥ä½œè¡¨
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet([]);
            XLSX.utils.book_append_sheet(wb, ws, 'åˆå¹¶æŠ¥è¡¨');

            log('\nğŸ§© å¼€å§‹å†™å…¥åˆå¹¶æŠ¥è¡¨...');
            const sortedRows = Object.keys(finalData).map(Number).sort((a, b) => a - b);
            for (const rowIdx of sortedRows) {
                const values = finalData[rowIdx];
                if (!values.some(v => typeof v === 'string' && v.trim())) {
                    log(`âš ï¸ è­¦å‘Šï¼šç¬¬${rowIdx}è¡Œå†…å®¹ä¸ºç©ºï¼Œå·²è·³è¿‡å†™å…¥ã€‚`);
                    continue;
                }
                const row = values.reduce((acc, val, colIdx) => {
                    // å°† null æˆ– undefined æ›¿æ¢ä¸º ''ï¼Œç¡®ä¿ç©ºå•å…ƒæ ¼
                    acc[XLSX.utils.encode_cell({ r: rowIdx - 1, c: colIdx })] = { v: val == null ? '' : val };
                    return acc;
                }, {});
                Object.assign(ws, row);
                log(`âœï¸ å†™å…¥ç¬¬${rowIdx}è¡Œï¼š${JSON.stringify(values)}`);
            }
            ws['!ref'] = XLSX.utils.encode_range({ s: { r: 0, c: 0 }, e: { r: Math.max(...sortedRows) - 1, c: Math.max(...Object.values(finalData).map(v => v.length)) - 1 } });

            // ç”Ÿæˆå¹¶ä¸‹è½½ Excel æ–‡ä»¶
            XLSX.writeFile(wb, config.output_file);
            log(`\nâœ… åˆå¹¶å®Œæˆï¼Œç»“æœå·²ä¿å­˜ä¸ºï¼š${config.output_file}`);
        }
    </script>
</body>
</html>